<div class="w-full max-w-md mx-auto p-6 bg-white/80 rounded-3xl shadow-lg backdrop-blur-sm animate-glow">
  
  @if (paymentStatus() === 'success') {
    <div class="text-center relative">
      <!-- Sparkle decorations for success -->
      <div class="absolute -top-2 -left-2 text-gold-accent opacity-80">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 animate-sparkle" viewBox="0 0 20 20" fill="currentColor">
          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
        </svg>
      </div>
       <div class="absolute -bottom-4 -right-2 text-powder-pink opacity-80">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 animate-sparkle" style="animation-delay: 0.5s" viewBox="0 0 20 20" fill="currentColor">
          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
        </svg>
      </div>

      <h2 class="font-serif text-3xl font-bold text-green-600 mb-4">Магия свершилась!</h2>
      <p class="font-sans mb-6">Ваш полный отчёт доступен ниже. Мы также отправили копию вам на почту {{ stateService.userEmail() }}.</p>
      
      @if(isLoadingPaidContent()) {
        <div class="flex justify-center items-center p-8">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-gold-accent"></div>
        </div>
      } @else {
        <div class="text-left bg-beige/50 p-4 rounded-xl space-y-6">
          
          @if(paidContent().paidPortrait; as portrait) {
            <div class="p-4 bg-white/50 rounded-lg">
              <h3 class="font-serif text-2xl font-semibold flex items-center gap-2 mb-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg>Ваш персональный образ</h3>
              <img [src]="portrait" (click)="showImage(portrait)" alt="Персональный образ в стиле" class="rounded-lg shadow-md w-full h-auto object-cover aspect-[3/4] mt-2 cursor-pointer hover:opacity-90 transition-opacity">
            </div>
          }

          <!-- Full Crystals Section -->
          @if(paidContent().crystals) {
            <div class="p-4 bg-white/50 rounded-lg">
              <h3 class="font-serif text-2xl font-semibold flex items-center gap-2 mb-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v2a2 2 0 01-2 2H7a2 2 0 01-2-2V4zm11.293 7.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 12H5.414l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L5.414 10h9.172l-3.293-3.293a1 1 0 011.414-1.414l4 4z" /></svg>Твои камни-талисманы</h3>
              <div class="space-y-4 mt-2">
                @for(crystal of paidContent().crystals; track crystal.name) {
                  <div class="flex items-start gap-4 p-3 bg-white/50 rounded-lg">
                    <img [src]="crystal.photoUrl" (click)="showImage(crystal.photoUrl)" [alt]="crystal.name" class="w-20 h-20 rounded-md object-cover cursor-pointer hover:opacity-90 transition-opacity">
                    <div>
                      <h4 class="font-serif text-lg font-bold">{{crystal.name}}</h4>
                      <p class="font-sans text-sm">{{crystal.description}}</p>
                      <p class="font-sans text-sm mt-1 italic"><strong>Практика:</strong> {{crystal.usage}}</p>
                    </div>
                  </div>
                }
              </div>
            </div>
          }
           <!-- Full Celebrities Section -->
          @if(paidContent().celebrities) {
            <div class="p-4 bg-white/50 rounded-lg">
              <h3 class="font-serif text-2xl font-semibold flex items-center gap-2 mb-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 00-1 1v1a1 1 0 002 0V3a1 1 0 00-1-1zM4 10a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm14 0a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM10 16a1 1 0 01-1 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM16 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM3 10a1 1 0 01-1 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM10 4a1 1 0 01-1 1v1a1 1 0 11-2 0V5a1 1 0 011-1zM16 4a1 1 0 01-1 1v1a1 1 0 11-2 0V5a1 1 0 011-1zM3 4a1 1 0 01-1 1v1a1 1 0 11-2 0V5a1 1 0 011-1z" clip-rule="evenodd" /></svg>Сходство со знаменитостями</h3>
              <div class="space-y-4 mt-2">
                @for(celebrity of paidContent().celebrities; track celebrity.name) {
                  <div class="p-3 bg-white/50 rounded-lg">
                    <div class="flex items-center gap-4">
                      <img [src]="celebrity.photoUrl" (click)="showImage(celebrity.photoUrl)" [alt]="celebrity.name" class="w-20 h-20 rounded-full object-cover cursor-pointer hover:opacity-90 transition-opacity">
                      <div>
                        <h4 class="font-serif text-lg font-bold">{{celebrity.name}}</h4>
                        <p class="font-sans text-sm font-bold text-gold-accent">Сходство: {{celebrity.similarity}}%</p>
                      </div>
                    </div>
                    <p class="font-sans text-sm mt-2 italic">"{{celebrity.reason}}"</p>
                  </div>
                }
              </div>
            </div>
          }
          <!-- Full Interior Design Section -->
          @if(paidContent().interiorDesign) {
            <div class="p-4 bg-white/50 rounded-lg">
              <h3 class="font-serif text-2xl font-semibold flex items-center gap-2 mb-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>Гармония твоего дома</h3>
              <div class="space-y-2 mt-2">
                @for(recommendation of paidContent().interiorDesign.recommendations; track recommendation) {
                    <div class="p-3 bg-white/50 rounded-lg">
                       <p class="font-sans text-sm">{{recommendation}}</p>
                    </div>
                }
              </div>
              <h4 class="font-serif text-lg font-bold mt-4 mb-2">Примеры для вдохновения:</h4>
              <div class="grid grid-cols-2 gap-2">
                @for(image of paidContent().interiorDesign.exampleImages; track image) {
                    <img [src]="image" (click)="showImage(image)" [alt]="'Пример интерьера'" class="rounded-md object-cover cursor-pointer hover:opacity-90 transition-opacity w-full h-auto aspect-[3/2]">
                }
              </div>
            </div>
          }
        </div>
        <app-share [shareText]="shareText" [shareTitle]="shareTitle"></app-share>
      }
    </div>
  } @else {
    @if (paymentStatus() === 'cancelled') {
        <p class="text-center text-red-600 bg-red-100 p-3 rounded-lg mb-4">Платёж был отменён. Вы можете попробовать снова в любое время.</p>
    }
    <div class="text-center">
      <h1 class="font-serif text-4xl font-bold mb-2">Раскрой свой потенциал</h1>
      <p class="font-sans text-lg mb-8 text-dark-purple/80">Ты на пороге великих открытий. Выбери свой путь к полной гармонии.</p>
    </div>

    <div class="space-y-4">
      <div class="p-6 bg-gradient-to-br from-powder-pink to-gold-accent/30 rounded-2xl border border-gold-accent/50 shadow-md transform hover:scale-105 transition-transform">
        <h3 class="font-serif text-2xl font-semibold flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 00-1 1v1a1 1 0 002 0V3a1 1 0 00-1-1zM4 10a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm14 0a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM10 16a1 1 0 01-1 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM16 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM3 10a1 1 0 01-1 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM10 4a1 1 0 01-1 1v1a1 1 0 11-2 0V5a1 1 0 011-1zM16 4a1 1 0 01-1 1v1a1 1 0 11-2 0V5a1 1 0 011-1zM3 4a1 1 0 01-1 1v1a1 1 0 11-2 0V5a1 1 0 011-1z" clip-rule="evenodd" /></svg>Полный детейлинг</h3>
        <p class="font-sans text-sm text-dark-purple/70 mt-1 mb-3">Полный анализ, талисманы, знаменитости, эксклюзивные образы и обновления.</p>
        <button (click)="openPaymentModal('subscription')" class="w-full bg-gold-accent text-white font-bold py-2 px-4 rounded-xl hover:opacity-90 transition-opacity">
          Подписка – 499 ₽/мес
        </button>
      </div>
      
      <div class="p-6 bg-dark-purple/80 text-white rounded-2xl border border-lavender/30 shadow-md transform hover:scale-105 transition-transform">
         <h3 class="font-serif text-2xl font-semibold flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg>Персональный образ</h3>
        <p class="font-sans text-sm text-white/80 mt-1 mb-3">Уникальный нейро-арт образ, созданный на основе твоего типажа.</p>
        <button (click)="openPaymentModal('portrait')" class="w-full bg-white text-dark-purple font-bold py-2 px-4 rounded-xl hover:bg-white/90 transition-opacity">
          Разово – 790 ₽
        </button>
      </div>
    </div>
  }
</div>

<!-- Email Collection Modal -->
@if (showEmailModal()) {
  <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" (click)="closeModal()">
    <div class="bg-beige rounded-3xl p-8 shadow-2xl w-full max-w-sm" (click)="$event.stopPropagation()">
      <h3 class="font-serif text-2xl font-bold text-center mb-2">Почти готово!</h3>
      <p class="text-center font-sans text-dark-purple/80 mb-6">Для получения чека, полного отчёта и эксклюзивных рекомендаций укажите ваш email. Полезный контент без спама ✨</p>
      
      <div class="space-y-4">
        <div>
          <label for="email" class="font-sans text-sm font-medium">Ваш Email</label>
          <input type="email" id="email" name="email" [(ngModel)]="email" required placeholder="example@mail.com" class="mt-1 block w-full bg-white border border-lavender rounded-lg p-2 focus:ring-gold-accent focus:border-gold-accent transition">
        </div>
        
        <div class="flex items-start">
          <input id="consent" name="consent" type="checkbox" [(ngModel)]="consent" class="h-4 w-4 text-gold-accent border-gray-300 rounded focus:ring-gold-accent mt-1">
          <label for="consent" class="ml-2 text-sm font-sans text-dark-purple/80">
            Я согласен(-на) на рассылку полезных советов и обновлений.
          </label>
        </div>
      </div>
      
      @if (emailError()) {
        <p class="text-sm text-red-600 text-center mt-4">{{ emailError() }}</p>
      }
      
      <button (click)="proceedToPayment()" class="mt-6 w-full bg-gold-accent text-white font-bold py-3 px-4 rounded-xl hover:opacity-90 transition-opacity">
        Оплатить
      </button>
      
      <div id="payment-form-container" class="mt-4"></div>
    </div>
  </div>
}

<!-- Image Modal -->
@if (selectedImage(); as imageUrl) {
  <div (click)="hideImage()" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in">
    <img [src]="imageUrl" (click)="$event.stopPropagation()" alt="Пример образа в увеличенном виде" class="max-w-full max-h-full object-contain rounded-xl shadow-2xl" style="max-width: 1000px; max-height: 1000px;">
  </div>
}